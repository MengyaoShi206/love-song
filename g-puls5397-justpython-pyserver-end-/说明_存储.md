# 分布式存储系统配置指南

本项目支持使用SQLite（默认）或分布式存储系统（RabbitMQ、Elasticsearch、ClickHouse）来存储数据。分布式存储系统中，RabbitMQ用于临时存储，Elasticsearch用于缓存，ClickHouse用于长期存储。

## 配置文件

配置文件位于项目根目录下的`config.ini`，用于配置存储系统的类型和连接参数。

### 配置示例

```ini
[database]
# 数据库类型: sqlite 或 distributed
type = sqlite

[sqlite]
# SQLite数据库配置
name = db.sqlite3

[rabbitmq]
# RabbitMQ配置 (临时存储)
host = localhost
port = 5672
user = guest
password = guest
virtual_host = /

[elasticsearch]
# Elasticsearch配置 (缓存)
host = localhost
port = 9200
user = 
password = 
index_prefix = pyserver_

[clickhouse]
# ClickHouse配置 (长期存储)
host = localhost
port = 9000
user = default
password = 
database = pyserver
```

## 切换存储系统

要切换存储系统，只需修改配置文件中的`[database]`部分：

```ini
[database]
# 使用SQLite
type = sqlite

# 或使用分布式存储
# type = distributed
```

## 安装依赖

使用分布式存储系统需要安装以下依赖：

```bash
pip install pika elasticsearch clickhouse-driver
```

## 测试存储系统

### 通过Web接口测试

访问以下URL测试存储系统：

```
http://localhost:8000/api/test_storage/
```

### 通过Django命令测试

```bash
python manage.py test_storage
```

## 在代码中使用存储系统

### 示例代码

```python
from api.storage import RabbitMQClient, ElasticsearchClient, ClickHouseClient, StorageManager

# 检查是否使用分布式存储
if StorageManager.is_distributed_storage():
    # 使用RabbitMQ进行临时存储
    rabbitmq = RabbitMQClient()
    rabbitmq.publish('queue_name', {'key': 'value'})
    rabbitmq.close()
    
    # 使用Elasticsearch进行缓存
    es = ElasticsearchClient()
    es.index('index_name', 'doc_id', {'key': 'value'})
    
    # 使用ClickHouse进行长期存储
    ch = ClickHouseClient()
    ch.insert('table_name', {'column': 'value'})
```

## 存储系统说明

### RabbitMQ（临时存储）

RabbitMQ用于处理临时数据和消息队列，适合处理需要异步处理的任务，如：

- 用户活动日志
- 通知和消息
- 任务队列

### Elasticsearch（缓存）

Elasticsearch用于快速检索和缓存数据，适合处理需要全文搜索和复杂查询的数据，如：

- 用户资料搜索
- 简历搜索
- 工作岗位搜索

### ClickHouse（长期存储）

ClickHouse用于长期存储和分析数据，适合处理大量的结构化数据和分析查询，如：

- 用户行为分析
- 系统使用统计
- 长期数据归档

## 注意事项

1. 在生产环境中，请确保配置文件中的密码和敏感信息得到妥善保护。
2. 分布式存储系统需要单独安装和配置相应的服务器。
3. 使用分布式存储系统时，Django的ORM仍然使用SQLite（或其他关系型数据库）来存储核心数据模型。